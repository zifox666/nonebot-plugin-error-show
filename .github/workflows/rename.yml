name: Initialize Repository

on:
  workflow_dispatch:    # æ‰‹åŠ¨è§¦å‘ï¼Œå¯ç”¨äºä»“åº“é¦–æ¬¡åˆå§‹åŒ–
  push:
    paths:
      - 'LICENSE'      # å½“ LICENSE æ–‡ä»¶å‘ç”Ÿå˜æ›´æ—¶è§¦å‘
      - '!.github/**'

jobs:
  init:
    if: github.ref_type != 'tag'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # è·å–å®Œæ•´å†å²ä»¥ç¡®ä¿å¯ä»¥æ­£ç¡®æäº¤
          token: ${{ secrets.GITHUB_TOKEN }}  # ä½¿ç”¨å…·æœ‰å†™å…¥æƒé™çš„token

      - name: Set repository variables
        run: |
          # ä»ç¯å¢ƒå˜é‡ GITHUB_REPOSITORY ä¸­æå–ä»“åº“åç§°å’Œæ‰€æœ‰è€…ï¼ˆæ ¼å¼ä¸º owner/repoï¼‰
          REPO_FULL="${GITHUB_REPOSITORY}"
          REPO_OWNER="${REPO_FULL%/*}"
          REPO_NAME="${REPO_FULL#*/}"
          # å°†æ¨ªæ æ›¿æ¢ä¸ºä¸‹åˆ’çº¿
          UNDERSCORE_REPO_NAME=$(echo "$REPO_NAME" | tr '-' '_')
          echo "REPO_OWNER=${REPO_OWNER}" >> $GITHUB_ENV
          echo "REPO_NAME=${REPO_NAME}" >> $GITHUB_ENV
          echo "UNDERSCORE_REPO_NAME=${UNDERSCORE_REPO_NAME}" >> $GITHUB_ENV
          echo "Repository owner: $REPO_OWNER"
          echo "Repository name: $REPO_NAME"
          echo "Repository underscore name: $UNDERSCORE_REPO_NAME"
      
      - name: Update README.md
        run: |
          # æ›¿æ¢ README.md ä¸­çš„å†…å®¹
          rm -f README.md
          sed -i.bak "s/{owner}/${REPO_OWNER}/g" readme_template.md
          sed -i.bak "s/{plugin-name}/${REPO_NAME}/g" readme_template.md
          sed -i.bak "s/nonebot_plugin_template/${UNDERSCORE_REPO_NAME}/g" readme_template.md
          mv readme_template.md README.md
          rm -f README.md.bak
          rm -f readme_template.md.bak

      - name: Update pyproject.toml
        run: |
          # æ›¿æ¢ pyproject.toml ä¸­çš„å†…å®¹
          sed -i.bak "s/nonebot-plugin-template/${REPO_NAME}/g" pyproject.toml
          sed -i.bak "s/owner/${REPO_OWNER}/g" pyproject.toml
          sed -i.bak "s/nonebot_plugin_template/${UNDERSCORE_REPO_NAME}/g" pyproject.toml
          rm -f pyproject.toml.bak

      - name: Rename plugin metadata
        run : |
          # ä¿®æ”¹ nonebot_plugin_template/__init__.py ä¸­çš„æ’ä»¶å…ƒæ•°æ® ä¸­çš„ homepage
          sed -i.bak "s/owner/${REPO_OWNER}/g" src/nonebot_plugin_template/__init__.py
          sed -i.bak "s/nonebot-plugin-template/${REPO_NAME}/g" src/nonebot_plugin_template/__init__.py
          rm -f src/nonebot_plugin_template/__init__.py.bak

      - name: Rename plugin folder
        run: |
          if [ -d "src/nonebot_plugin_template" ]; then
            mv src/nonebot_plugin_template "src/${UNDERSCORE_REPO_NAME}"
            echo "Successfully renamed plugin folder to ${UNDERSCORE_REPO_NAME}"
          else
            echo "Directory src/nonebot_plugin_template not found."
            exit 1
          fi

      - name: Rename tests/plugin_test plugin name
        run: |
          # ä¿®æ”¹ tests/plugin_test.py ä¸­çš„æ’ä»¶åç§°
          sed -i.bak "s/nonebot_plugin_template/${UNDERSCORE_REPO_NAME}/g" tests/plugin_test.py
          rm -f tests/plugin_test.py.bak

      - name: Commit and push changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add .
          git commit -m "ğŸ‰ Initialize repository with correct naming"
          git push